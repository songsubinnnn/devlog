<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Devlog</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
  <div class="header">
    <h1 th:text="${isEdit}? 'âœï¸ ê²Œì‹œê¸€ ìˆ˜ì •' : 'âœï¸ ìƒˆ ê²Œì‹œê¸€'">âœï¸ ìƒˆ ê²Œì‹œê¸€</h1>
    <p>ë‹¹ì‹ ì˜ ì—¬ì •ì„ ê¸°ë¡í•´ë³´ì„¸ìš”</p>
  </div>

  <div class="form-container">
    <form id="postForm" enctype="multipart/form-data" th:object="${postDTO}">
      <input type="hidden" id="id" name="id" th:value="${postDTO.id}"/>
      <input type="hidden" id="deletedFilesId" name="deletedFilesId"/>

      <div class="form-group">
        <label for="title">ğŸ“ ì œëª©</label>
        <input type="text" id="title" name="title" th:field="*{title}"
               class="form-input" placeholder="ë©‹ì§„ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required>
      </div>

      <div class="form-group">
        <label for="content">ğŸ“„ ë³¸ë¬¸</label>
        <textarea id="content" name="content" th:field="*{content}"
                  class="form-input" placeholder="ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”." required></textarea>
      </div>

      <div class="form-group">
        <label for="tags">ğŸ·ï¸ íƒœê·¸</label>
        <input type="text" id="tags" name="tags" th:field="*{tags}"
               class="form-input" placeholder="#Java, #Spring, #React...">
      </div>

      <div class="form-group">
        <label for="thumbnail">ğŸ–¼ï¸ ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
        <!-- ê¸°ì¡´ ì¸ë„¤ì¼ íŒŒì¼ë“¤ -->
        <div id="existingThumbnailFiles" class="existing-files-container">
          <div th:if="${postDTO.thumbnail != null}" class="existing-file-item"
               th:data-file-id="${postDTO.thumbnail.id}">
            <div class="file-info">
              <span class="file-icon">ğŸ–¼ï¸</span>
              <a th:href="@{/files/{id}(id=${postDTO.thumbnail.id})}"
                 th:text="${postDTO.thumbnail.originalFileName}"
                 class="file-link">íŒŒì¼ëª…</a>
            </div>
            <button type="button" class="delete-existing-file-btn" th:data-file-id="${postDTO.thumbnail.id}">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
        </div>
        <!-- ìƒˆë¡œ ì„ íƒëœ ì¸ë„¤ì¼ íŒŒì¼ë“¤ -->
        <div id="newThumbnailFiles" class="new-files-container"></div>
        <div class="file-input-container">
          <input type="file" id="thumbnail" name="thumbnail" class="file-input" accept="image/*">
          <label for="thumbnail" class="file-label">
            ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>ğŸ“ ì²¨ë¶€íŒŒì¼</label>
        <!-- ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ë“¤ -->
        <div id="existingAttachmentFiles" class="existing-files-container" th:if="${postDTO.attachments != null}">
          <div th:each="file : ${postDTO.attachments}" class="existing-file-item" th:data-file-id="${file.id}">
            <input type="hidden" name="existingAttachmentsId" th:value="${file.id}"/>
            <div class="file-info">
              <span class="file-icon">ğŸ“</span>
              <a th:href="@{/files/{id}(id=${file.id})}"
                 th:text="${file.originalFileName}"
                 class="file-link">íŒŒì¼ëª…</a>
            </div>
            <button type="button" class="delete-existing-file-btn" th:data-file-id="${file.id}">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
        </div>
        <!-- ì¶”ê°€ëœ ì²¨ë¶€íŒŒì¼ë“¤ -->
        <div id="newAttachmentFiles" class="new-files-container"></div>
        <!-- íŒŒì¼ ì…ë ¥ ì˜ì—­ë“¤ -->
        <div id="fileInputsContainer">
          <!-- ì´ˆê¸° íŒŒì¼ ì…ë ¥ ì˜ì—­-->
          <div class="file-input-container" id="container-attachments0">
            <input type="file" id="attachments0" name="temp-attachments" class="file-input">
            <label for="attachments0" class="file-label">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
          </div>
        </div>
      </div>

      <div class="submit-container">
        <button type="button" class="list-btn" onclick="goToList()">
          ğŸ“‹ ëª©ë¡
        </button>
        <button type="submit" class="submit-btn" id="submitBtn">
          <span th:text="${isEdit}? 'ìˆ˜ì •í•˜ê¸°' : 'ê²Œì‹œí•˜ê¸°'">ê²Œì‹œí•˜ê¸°</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script th:if="${alertMessage}">
  alert('[[${alertMessage}]]');
</script>

<script>
  let fileInputCounter = 1; // 0ë²ˆì€ ì´ë¯¸ ì •ì ìœ¼ë¡œ ìƒì„±ë˜ì–´ ìˆìœ¼ë¯€ë¡œ 1ë¶€í„° ì‹œì‘
  const deletedFilesId = [];
  const attachmentFiles = new Map(); // key: inputId, value: File object
  const isEdit = [[${isEdit}]];

  // ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
  function goToList() {
    window.location.href = '/posts';
  }

  // ì´ˆê¸° íŒŒì¼ ì…ë ¥ ì˜ì—­ ì„¤ì •
  function setupInitialFileInput() {
    const initialInput = document.getElementById('attachments0');
    if (initialInput) {
      initialInput.addEventListener('change', function () { // íŒŒì¼ì´ ì„ íƒ ë˜ë©´
        handleFileSelection(this);
      });
    }
  }

  // ìƒˆë¡œìš´ íŒŒì¼ ì…ë ¥ ì˜ì—­ ìƒì„±
  function createNewFileInputArea() {
    const container = document.getElementById('fileInputsContainer');
    const inputId = `attachments${fileInputCounter++}`;

    const inputContainer = document.createElement('div');
    inputContainer.className = 'file-input-container';
    inputContainer.id = `container-${inputId}`;

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = inputId;
    fileInput.name = 'temp-attachments';
    fileInput.className = 'file-input';

    const label = document.createElement('label');
    label.setAttribute('for', inputId);
    label.className = 'file-label';
    label.textContent = 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';

    inputContainer.appendChild(fileInput);
    inputContainer.appendChild(label);
    container.appendChild(inputContainer);

    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    fileInput.addEventListener('change', function () {
      handleFileSelection(this);
    });

    return inputId;
  }

  // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
  function handleFileSelection(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      const inputId = input.id;
      input.name = 'attachments';

      // ì„ íƒëœ íŒŒì¼ì„ Mapì— ì €ì¥
      attachmentFiles.set(inputId, file);

      // ì„ íƒëœ íŒŒì¼ í‘œì‹œ ì˜ì—­ì— ì¶”ê°€
      createSelectedFileDisplay(file, inputId);

      // í˜„ì¬ input ìˆ¨ê¹€
      console.log(inputId);
      const container = document.getElementById(`container-${inputId}`);
      container.style.display = 'none';

      // ìƒˆë¡œìš´ input ìƒì„±
      createNewFileInputArea();
    }
  }

  // ì„ íƒëœ íŒŒì¼ í‘œì‹œ ìƒì„±
  function createSelectedFileDisplay(file, inputId) {
    const container = document.getElementById('newAttachmentFiles');

    const fileDiv = document.createElement('div');
    fileDiv.className = 'new-file-item';
    fileDiv.setAttribute('data-input-id', inputId);

    const fileInfo = document.createElement('div');
    fileInfo.className = 'file-info';

    const fileIcon = document.createElement('span');
    fileIcon.className = 'file-icon';
    fileIcon.textContent = 'ğŸ“';

    const fileName = document.createElement('span');
    fileName.className = 'file-name';
    fileName.textContent = file.name;

    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'delete-new-file-btn';
    deleteBtn.textContent = 'ğŸ—‘ï¸ ì‚­ì œ';
    deleteBtn.setAttribute('data-input-id', inputId);

    fileInfo.appendChild(fileIcon);
    fileInfo.appendChild(fileName);
    fileDiv.appendChild(fileInfo);
    fileDiv.appendChild(deleteBtn);

    container.appendChild(fileDiv);

    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    deleteBtn.addEventListener('click', function () {
      removeSelectedFile(inputId);
    });
  }

  // ì„ íƒëœ íŒŒì¼ ì‚­ì œ
  function removeSelectedFile(inputId) {
    // Mapì—ì„œ íŒŒì¼ ì œê±°
    attachmentFiles.delete(inputId);

    // í‘œì‹œ ì˜ì—­ì—ì„œ ì œê±°
    const fileDisplay = document.querySelector(`#newAttachmentFiles .new-file-item[data-input-id="${inputId}"]`);
    if (fileDisplay) {
      fileDisplay.remove();
    }

    // í•´ë‹¹ input ì»¨í…Œì´ë„ˆ ì œê±°
    const inputContainer = document.getElementById(`container-${inputId}`);
    if (inputContainer) {
      inputContainer.remove();
    }
  }

  // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
  function removeExistingFile(fileId) {
    if (!deletedFilesId.includes(fileId)) {
      deletedFilesId.push(fileId);
    }

    const fileItem = document.querySelector(`.existing-file-item[data-file-id="${fileId}"]`);
    if (fileItem) {
      fileItem.remove();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // ì´ˆê¸° íŒŒì¼ ì…ë ¥ ì˜ì—­ ì´ë²¤íŠ¸ ì„¤ì •
    setupInitialFileInput();
    console.log(isEdit);
    // ì¸ë„¤ì¼ íŒŒì¼ ì…ë ¥ ì²˜ë¦¬
    const thumbnailInput = document.getElementById('thumbnail');
    if (thumbnailInput) {
      thumbnailInput.addEventListener('change', function () {
        const newThumbnailContainer = document.getElementById('newThumbnailFiles');
        newThumbnailContainer.innerHTML = '';

        if (this.files && this.files[0]) {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'new-file-item';

          const fileInfo = document.createElement('div');
          fileInfo.className = 'file-info';

          const fileIcon = document.createElement('span');
          fileIcon.className = 'file-icon';
          fileIcon.textContent = 'ğŸ–¼ï¸';

          const fileName = document.createElement('span');
          fileName.className = 'file-name';
          fileName.textContent = this.files[0].name;

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'delete-new-file-btn';
          deleteBtn.textContent = 'ğŸ—‘ï¸ ì‚­ì œ';

          fileInfo.appendChild(fileIcon);
          fileInfo.appendChild(fileName);
          fileDiv.appendChild(fileInfo);
          fileDiv.appendChild(deleteBtn);

          newThumbnailContainer.appendChild(fileDiv);

          deleteBtn.addEventListener('click', function () {
            thumbnailInput.value = '';
            newThumbnailContainer.innerHTML = '';
            const label = thumbnailInput.nextElementSibling;
            if (label) {
              label.textContent = 'ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
            }
          });
        }
      });
    }

    // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const deleteExistingBtns = document.querySelectorAll('.delete-existing-file-btn');
    deleteExistingBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        const fileId = this.getAttribute('data-file-id');
        removeExistingFile(fileId);
      });
    });

    // submit
    const form = document.getElementById('postForm');

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      try {
        const formData = new FormData(form);

        const postId = document.getElementById('id').value;
        const method = isEdit ? 'PUT' : 'POST';
        console.log(method);
        const url = isEdit ? `/api/posts/${postId}` : '/api/posts';

        try {
          const response = await fetch(url, {
            method: method,
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            alert('ë“±ë¡ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = `/posts/${result.id}`;
          } else {
            const error = await response.text();
            throw new Error(error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('Form submission error:', error);
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }

      } catch (error) {
        console.error('Form processing error:', error);
        alert('í¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {

      }
    });
  });
</script>

<style>
  .file-input-container {
    margin-bottom: 10px;
  }

  .new-file-item, .existing-file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background-color: #f5f5f5;
    border-radius: 4px;
    margin-bottom: 5px;
  }

  .file-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .file-name {
    font-size: 14px;
    color: #333;
  }

  .file-link {
    font-size: 14px;
    color: #007bff;
    text-decoration: none;
  }

  .file-link:hover {
    text-decoration: underline;
  }

  .delete-new-file-btn, .delete-existing-file-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .delete-new-file-btn:hover, .delete-existing-file-btn:hover {
    background: #ff3742;
  }

  .submit-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .existing-files-container, .new-files-container {
    margin-bottom: 10px;
  }
</style>
</body>
</html>
