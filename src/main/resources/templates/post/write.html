<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Devlog</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
  <div class="header">
    <h1 th:text="${isEdit}? 'âœï¸ ê²Œì‹œê¸€ ìˆ˜ì •' : 'âœï¸ ìƒˆ ê²Œì‹œê¸€'">âœï¸ ìƒˆ ê²Œì‹œê¸€</h1>
    <p>ë‹¹ì‹ ì˜ ì—¬ì •ì„ ê¸°ë¡í•´ë³´ì„¸ìš”</p>
  </div>

  <div class="form-container">
    <form id="postForm" th:action="${isEdit} ? @{/posts/{id}(id=${postDTO.id})} : @{/posts}" enctype="multipart/form-data" th:object="${postDTO}" method="post">
      <input type="hidden" id="id" name="id" th:value="${postDTO.id}"/>
      <input type="hidden" id="deletedFilesId" name="deletedFilesId"/>
      <input type="hidden" name="_method" th:value="${isEdit} ? 'put' : ''"/>

      <div class="form-group">
        <label for="title">ğŸ“ ì œëª©</label>
        <input type="text" id="title" name="title" th:field="*{title}"
               class="form-input" placeholder="ë©‹ì§„ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required>
      </div>

      <div class="form-group">
        <label for="content">ğŸ“„ ë³¸ë¬¸</label>
        <textarea id="content" name="content" th:field="*{content}"
                  class="form-input" placeholder="ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”." required></textarea>
      </div>

      <div class="form-group">
        <label for="tags">ğŸ·ï¸ íƒœê·¸</label>
        <input type="text" id="tags" name="tags" th:field="*{tags}"
               class="form-input" placeholder="#Java, #Spring, #React...">
      </div>

      <div class="form-group">
        <label for="thumbnail">ğŸ–¼ï¸ ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
        <!-- ê¸°ì¡´ ì¸ë„¤ì¼ íŒŒì¼ë“¤ -->
        <div id="existingThumbnailFiles" class="existing-files-container">
          <div th:if="${postDTO.thumbnail != null}" class="existing-file-item" th:data-file-id="${postDTO.thumbnail.id}">
            <div class="file-info">
              <span class="file-icon">ğŸ–¼ï¸</span>
              <a th:href="@{/files/{id}(id=${postDTO.thumbnail.id})}"
                 th:text="${postDTO.thumbnail.originalFileName}"
                 class="file-link">íŒŒì¼ëª…</a>
            </div>
            <button type="button" class="delete-existing-file-btn" th:data-file-id="${postDTO.thumbnail.id}">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
        </div>
        <!-- ìƒˆë¡œ ì„ íƒëœ ì¸ë„¤ì¼ íŒŒì¼ë“¤ -->
        <div id="newThumbnailFiles" class="new-files-container"></div>
        <div class="file-input-container">
          <input type="file" id="thumbnail" name="thumbnail" class="file-input" accept="image/*">
          <label for="thumbnail" class="file-label">
            ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>ğŸ“ ì²¨ë¶€íŒŒì¼</label>
        <!-- ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ë“¤ -->
        <div id="existingAttachmentFiles" class="existing-files-container">
          <div th:each="file : ${postDTO.attachments}" class="existing-file-item" th:data-file-id="${file.id}">
            <div class="file-info">
              <span class="file-icon">ğŸ“</span>
              <a th:href="@{/files/{id}(id=${file.id})}"
                 th:text="${file.originalFileName}"
                 class="file-link">íŒŒì¼ëª…</a>
            </div>
            <button type="button" class="delete-existing-file-btn" th:data-file-id="${file.id}">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
        </div>
        <!-- ìƒˆë¡œ ì„ íƒëœ ì²¨ë¶€íŒŒì¼ë“¤ -->
        <div id="newAttachmentFiles" class="new-files-container"></div>
        <div id="fileInputs" class="file-inputs-container">
          <div class="file-input-container">
            <input type="file" id="attachments" name="attachments" class="file-input">
            <label for="attachments" class="file-label">
              íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”
            </label>
          </div>
        </div>
        <button type="button" class="add-file-btn" onclick="addFileInput()">
          â• íŒŒì¼ ì¶”ê°€
        </button>
      </div>

      <div class="submit-container">
        <button type="button" class="list-btn" onclick="goToList()">
          ğŸ“‹ ëª©ë¡
        </button>
        <button type="submit" class="submit-btn" id="submitBtn">
          <span th:text="${isEdit}? 'ìˆ˜ì •í•˜ê¸°' : 'ê²Œì‹œí•˜ê¸°'">ê²Œì‹œí•˜ê¸°</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script th:if="${alertMessage}">
  alert('[[${alertMessage}]]');
</script>

<script>
  let fileCounter = 0;
  const deletedFilesId = [];

  // ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
  function goToList() {
    window.location.href = '/posts';
  }

  // íŒŒì¼ ì¶”ê°€
  function addFileInput() {
    const container = document.getElementById("fileInputs");
    const fileInputDiv = document.createElement("div");
    fileInputDiv.className = "additional-file-input";

    const input = document.createElement("input");
    input.type = "file";
    input.name = "attachments";
    input.className = "file-input";

    const label = document.createElement("label");
    label.className = "file-label";
    label.textContent = "ì¶”ê°€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”";
    label.style.cursor = "pointer";

    // ê³ ìœ  ID ìƒì„±
    const uniqueId = 'file-' + Date.now() + '-' + (++fileCounter);
    input.id = uniqueId;
    label.setAttribute('for', uniqueId);

    const fileContainer = document.createElement("div");
    fileContainer.className = "file-input-container";
    fileContainer.appendChild(input);
    fileContainer.appendChild(label);

    fileInputDiv.appendChild(fileContainer);
    container.appendChild(fileInputDiv);

    // íŒŒì¼ ì„ íƒ ì‹œ ìƒˆ íŒŒì¼ div ìƒì„±
    input.addEventListener('change', function () {
      if (this.files && this.files[0]) {
        createNewFileDiv(this.files[0], 'attachments', uniqueId);
      }
    });
  }

  // ìƒˆë¡œìš´ íŒŒì¼ div ìƒì„±
  function createNewFileDiv(file, type, inputId) {
    const container = type === 'thumbnail' ?
      document.getElementById('newThumbnailFiles') :
      document.getElementById('newAttachmentFiles');

    const fileDiv = document.createElement('div');
    fileDiv.className = 'new-file-item';
    fileDiv.setAttribute('data-input-id', inputId);

    const fileInfo = document.createElement('div');
    fileInfo.className = 'file-info';

    const fileIcon = document.createElement('span');
    fileIcon.className = 'file-icon';
    fileIcon.textContent = type === 'thumbnail' ? 'ğŸ–¼ï¸' : 'ğŸ“';

    const fileName = document.createElement('span');
    fileName.className = 'file-name';
    fileName.textContent = file.name;

    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'delete-new-file-btn';
    deleteBtn.textContent = 'ğŸ—‘ï¸ ì‚­ì œ';
    deleteBtn.setAttribute('data-input-id', inputId);

    fileInfo.appendChild(fileIcon);
    fileInfo.appendChild(fileName);
    fileDiv.appendChild(fileInfo);
    fileDiv.appendChild(deleteBtn);

    container.appendChild(fileDiv);

    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    deleteBtn.addEventListener('click', function() {
      removeNewFile(inputId);
    });
  }

  // ìƒˆë¡œìš´ íŒŒì¼ ì‚­ì œ
  function removeNewFile(inputId) {
    // íŒŒì¼ div ì œê±°
    const thumbnailDiv = document.querySelector(`#newThumbnailFiles .new-file-item[data-input-id="${inputId}"]`);
    const attachmentDiv = document.querySelector(`#newAttachmentFiles .new-file-item[data-input-id="${inputId}"]`);

    if (thumbnailDiv) thumbnailDiv.remove();
    if (attachmentDiv) attachmentDiv.remove();

    // í•´ë‹¹ input ì´ˆê¸°í™”
    const input = document.getElementById(inputId);
    if (input) {
      input.value = '';
      const label = input.nextElementSibling;
      if (label) {
        if (input.id === 'thumbnail') {
          label.textContent = 'ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
        } else if (input.id === 'attachments') {
          label.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”';
        } else {
          label.textContent = 'ì¶”ê°€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
        }
        label.style.color = '';
      }
    }
  }

  // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
  function removeExistingFile(fileId) {
    if (!deletedFilesId.includes(fileId)) {
      deletedFilesId.push(fileId);
      document.getElementById('deletedFilesId').value = deletedFilesId.join(',');
    }

    const fileItem = document.querySelector(`.existing-file-item[data-file-id="${fileId}"]`);
    if (fileItem) {
      fileItem.remove();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // ì¸ë„¤ì¼ íŒŒì¼ ì…ë ¥ ì²˜ë¦¬
    const thumbnailInput = document.getElementById('thumbnail');
    if (thumbnailInput) {
      thumbnailInput.addEventListener('change', function() {
        // ê¸°ì¡´ ìƒˆ íŒŒì¼ divë“¤ ì œê±°
        const newThumbnailContainer = document.getElementById('newThumbnailFiles');
        newThumbnailContainer.innerHTML = '';

        if (this.files && this.files[0]) {
          createNewFileDiv(this.files[0], 'thumbnail', this.id);
        }
      });
    }

    // ì²¨ë¶€íŒŒì¼ ì…ë ¥ ì²˜ë¦¬
    const attachmentsInput = document.getElementById('attachments');
    if (attachmentsInput) {
      attachmentsInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          createNewFileDiv(this.files[0], 'attachments', this.id);
        }
      });
    }

    // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const deleteExistingBtns = document.querySelectorAll('.delete-existing-file-btn');
    deleteExistingBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const fileId = this.getAttribute('data-file-id');
        removeExistingFile(fileId);
      });
    });

    // í¼ ì œì¶œ ì‹œ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
    const form = document.getElementById('postForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', function () {
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'ì²˜ë¦¬ì¤‘...';
    });
  });
</script>
</body>
</html>
