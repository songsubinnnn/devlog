<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Devlog</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
  <div class="header">
    <h1 th:text="${isEdit}? '✏️ 게시글 수정' : '✏️ 새 게시글'">✏️ 새 게시글</h1>
    <p>당신의 여정을 기록해보세요</p>
  </div>

  <div class="form-container">
    <form id="postForm" enctype="multipart/form-data" th:object="${postDTO}">
      <input type="hidden" id="id" name="id" th:value="${postDTO.id}"/>
      <input type="hidden" id="deletedFilesId" name="deletedFilesId"/>

      <div class="form-group">
        <label for="title">📝 제목</label>
        <input type="text" id="title" name="title" th:field="*{title}"
               class="form-input" placeholder="멋진 제목을 입력해주세요." required>
      </div>

      <div class="form-group">
        <label for="content">📄 본문</label>
        <textarea id="content" name="content" th:field="*{content}"
                  class="form-input" placeholder="당신의 이야기를 들려주세요." required></textarea>
      </div>

      <div class="form-group">
        <label for="tags">🏷️ 태그</label>
        <input type="text" id="tags" name="tags" th:field="*{tags}"
               class="form-input" placeholder="#Java, #Spring, #React...">
      </div>

      <div class="form-group">
        <label for="thumbnail">🖼️ 썸네일 이미지</label>
        <!-- 기존 썸네일 파일들 -->
        <div id="existingThumbnailFiles" class="existing-files-container">
          <div th:if="${postDTO.thumbnail != null}" class="existing-file-item"
               th:data-file-id="${postDTO.thumbnail.id}">
            <div class="file-info">
              <span class="file-icon">🖼️</span>
              <a th:href="@{/files/{id}(id=${postDTO.thumbnail.id})}"
                 th:text="${postDTO.thumbnail.originalFileName}"
                 class="file-link">파일명</a>
            </div>
            <button type="button" class="delete-existing-file-btn" th:data-file-id="${postDTO.thumbnail.id}">
              🗑️ 삭제
            </button>
          </div>
        </div>
        <!-- 새로 선택된 썸네일 파일들 -->
        <div id="newThumbnailFiles" class="new-files-container"></div>
        <div class="file-input-container">
          <input type="file" id="thumbnail" name="thumbnail" class="file-input" accept="image/*">
          <label for="thumbnail" class="file-label">
            썸네일 이미지를 선택해주세요
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>📎 첨부파일</label>
        <!-- 기존 첨부파일들 -->
        <div id="existingAttachmentFiles" class="existing-files-container" th:if="${postDTO.attachments != null}">
          <div th:each="file : ${postDTO.attachments}" class="existing-file-item" th:data-file-id="${file.id}">
            <input type="hidden" name="existingAttachmentsId" th:value="${file.id}"/>
            <div class="file-info">
              <span class="file-icon">📎</span>
              <a th:href="@{/files/{id}(id=${file.id})}"
                 th:text="${file.originalFileName}"
                 class="file-link">파일명</a>
            </div>
            <button type="button" class="delete-existing-file-btn" th:data-file-id="${file.id}">
              🗑️ 삭제
            </button>
          </div>
        </div>
        <!-- 추가된 첨부파일들 -->
        <div id="newAttachmentFiles" class="new-files-container"></div>
        <!-- 파일 입력 영역들 -->
        <div id="fileInputsContainer">
          <!-- 초기 파일 입력 영역-->
          <div class="file-input-container" id="container-attachments0">
            <input type="file" id="attachments0" name="temp-attachments" class="file-input">
            <label for="attachments0" class="file-label">파일을 선택해주세요</label>
          </div>
        </div>
      </div>

      <div class="submit-container">
        <button type="button" class="list-btn" onclick="goToList()">
          📋 목록
        </button>
        <button type="submit" class="submit-btn" id="submitBtn">
          <span th:text="${isEdit}? '수정하기' : '게시하기'">게시하기</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script th:if="${alertMessage}">
  alert('[[${alertMessage}]]');
</script>

<script>
  let fileInputCounter = 1; // 0번은 이미 정적으로 생성되어 있으므로 1부터 시작
  const deletedFilesId = [];
  const attachmentFiles = new Map(); // key: inputId, value: File object
  const isEdit = [[${isEdit}]];

  // 목록 페이지로 이동
  function goToList() {
    window.location.href = '/posts';
  }

  // 초기 파일 입력 영역 설정
  function setupInitialFileInput() {
    const initialInput = document.getElementById('attachments0');
    if (initialInput) {
      initialInput.addEventListener('change', function () { // 파일이 선택 되면
        handleFileSelection(this);
      });
    }
  }

  // 새로운 파일 입력 영역 생성
  function createNewFileInputArea() {
    const container = document.getElementById('fileInputsContainer');
    const inputId = `attachments${fileInputCounter++}`;

    const inputContainer = document.createElement('div');
    inputContainer.className = 'file-input-container';
    inputContainer.id = `container-${inputId}`;

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = inputId;
    fileInput.name = 'temp-attachments';
    fileInput.className = 'file-input';

    const label = document.createElement('label');
    label.setAttribute('for', inputId);
    label.className = 'file-label';
    label.textContent = '파일을 선택해주세요';

    inputContainer.appendChild(fileInput);
    inputContainer.appendChild(label);
    container.appendChild(inputContainer);

    // 파일 선택 이벤트 리스너 추가
    fileInput.addEventListener('change', function () {
      handleFileSelection(this);
    });

    return inputId;
  }

  // 파일 선택 처리
  function handleFileSelection(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      const inputId = input.id;
      input.name = 'attachments';

      // 선택된 파일을 Map에 저장
      attachmentFiles.set(inputId, file);

      // 선택된 파일 표시 영역에 추가
      createSelectedFileDisplay(file, inputId);

      // 현재 input 숨김
      console.log(inputId);
      const container = document.getElementById(`container-${inputId}`);
      container.style.display = 'none';

      // 새로운 input 생성
      createNewFileInputArea();
    }
  }

  // 선택된 파일 표시 생성
  function createSelectedFileDisplay(file, inputId) {
    const container = document.getElementById('newAttachmentFiles');

    const fileDiv = document.createElement('div');
    fileDiv.className = 'new-file-item';
    fileDiv.setAttribute('data-input-id', inputId);

    const fileInfo = document.createElement('div');
    fileInfo.className = 'file-info';

    const fileIcon = document.createElement('span');
    fileIcon.className = 'file-icon';
    fileIcon.textContent = '📎';

    const fileName = document.createElement('span');
    fileName.className = 'file-name';
    fileName.textContent = file.name;

    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'delete-new-file-btn';
    deleteBtn.textContent = '🗑️ 삭제';
    deleteBtn.setAttribute('data-input-id', inputId);

    fileInfo.appendChild(fileIcon);
    fileInfo.appendChild(fileName);
    fileDiv.appendChild(fileInfo);
    fileDiv.appendChild(deleteBtn);

    container.appendChild(fileDiv);

    // 삭제 버튼 이벤트 리스너
    deleteBtn.addEventListener('click', function () {
      removeSelectedFile(inputId);
    });
  }

  // 선택된 파일 삭제
  function removeSelectedFile(inputId) {
    // Map에서 파일 제거
    attachmentFiles.delete(inputId);

    // 표시 영역에서 제거
    const fileDisplay = document.querySelector(`#newAttachmentFiles .new-file-item[data-input-id="${inputId}"]`);
    if (fileDisplay) {
      fileDisplay.remove();
    }

    // 해당 input 컨테이너 제거
    const inputContainer = document.getElementById(`container-${inputId}`);
    if (inputContainer) {
      inputContainer.remove();
    }
  }

  // 기존 파일 삭제
  function removeExistingFile(fileId) {
    if (!deletedFilesId.includes(fileId)) {
      deletedFilesId.push(fileId);
    }

    const fileItem = document.querySelector(`.existing-file-item[data-file-id="${fileId}"]`);
    if (fileItem) {
      fileItem.remove();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // 초기 파일 입력 영역 이벤트 설정
    setupInitialFileInput();
    console.log(isEdit);
    // 썸네일 파일 입력 처리
    const thumbnailInput = document.getElementById('thumbnail');
    if (thumbnailInput) {
      thumbnailInput.addEventListener('change', function () {
        const newThumbnailContainer = document.getElementById('newThumbnailFiles');
        newThumbnailContainer.innerHTML = '';

        if (this.files && this.files[0]) {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'new-file-item';

          const fileInfo = document.createElement('div');
          fileInfo.className = 'file-info';

          const fileIcon = document.createElement('span');
          fileIcon.className = 'file-icon';
          fileIcon.textContent = '🖼️';

          const fileName = document.createElement('span');
          fileName.className = 'file-name';
          fileName.textContent = this.files[0].name;

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'delete-new-file-btn';
          deleteBtn.textContent = '🗑️ 삭제';

          fileInfo.appendChild(fileIcon);
          fileInfo.appendChild(fileName);
          fileDiv.appendChild(fileInfo);
          fileDiv.appendChild(deleteBtn);

          newThumbnailContainer.appendChild(fileDiv);

          deleteBtn.addEventListener('click', function () {
            thumbnailInput.value = '';
            newThumbnailContainer.innerHTML = '';
            const label = thumbnailInput.nextElementSibling;
            if (label) {
              label.textContent = '썸네일 이미지를 선택해주세요';
            }
          });
        }
      });
    }

    // 기존 파일 삭제 버튼 이벤트 리스너
    const deleteExistingBtns = document.querySelectorAll('.delete-existing-file-btn');
    deleteExistingBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        const fileId = this.getAttribute('data-file-id');
        removeExistingFile(fileId);
      });
    });

    // submit
    const form = document.getElementById('postForm');

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      try {
        const formData = new FormData(form);

        const postId = document.getElementById('id').value;
        const method = isEdit ? 'PUT' : 'POST';
        console.log(method);
        const url = isEdit ? `/api/posts/${postId}` : '/api/posts';

        try {
          const response = await fetch(url, {
            method: method,
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            alert('등록 되었습니다.');
            window.location.href = `/posts/${result.id}`;
          } else {
            const error = await response.text();
            throw new Error(error || '저장에 실패했습니다.');
          }
        } catch (error) {
          console.error('Form submission error:', error);
          alert('오류가 발생했습니다: ' + error.message);
        }

      } catch (error) {
        console.error('Form processing error:', error);
        alert('폼 처리 중 오류가 발생했습니다.');
      } finally {

      }
    });
  });
</script>

<style>
  .file-input-container {
    margin-bottom: 10px;
  }

  .new-file-item, .existing-file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background-color: #f5f5f5;
    border-radius: 4px;
    margin-bottom: 5px;
  }

  .file-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .file-name {
    font-size: 14px;
    color: #333;
  }

  .file-link {
    font-size: 14px;
    color: #007bff;
    text-decoration: none;
  }

  .file-link:hover {
    text-decoration: underline;
  }

  .delete-new-file-btn, .delete-existing-file-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .delete-new-file-btn:hover, .delete-existing-file-btn:hover {
    background: #ff3742;
  }

  .submit-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .existing-files-container, .new-files-container {
    margin-bottom: 10px;
  }
</style>
</body>
</html>
