<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Devlog</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
  <div class="header">
    <h1 th:text="${isEdit}? '✏️ 게시글 수정' : '✏️ 새 게시글'">✏️ 새 게시글</h1>
    <p>당신의 여정을 기록해보세요</p>
  </div>

  <div class="form-container">
    <form id="postForm" th:action="${isEdit} ? @{/posts/{id}(id=${postDTO.id})} : @{/posts}"
          enctype="multipart/form-data" th:object="${postDTO}" method="post">

      <input type="hidden" id="id" name="id" th:value="${postDTO.id}"/>

      <div class="form-group">
        <label for="title">📝 제목</label>
        <input type="text" id="title" name="title" th:field="*{title}"
               class="form-input" placeholder="멋진 제목을 입력해주세요." required>
      </div>

      <div class="form-group">
        <label for="content">📄 본문</label>
        <textarea id="content" name="content" th:field="*{content}"
                  class="form-input" placeholder="당신의 이야기를 들려주세요." required></textarea>
      </div>

      <div class="form-group">
        <label for="tags">🏷️ 태그</label>
        <input type="text" id="tags" name="tags" th:field="*{tags}"
               class="form-input" placeholder="#Java, #Spring, #React...">
      </div>

      <div class="form-group">
        <label for="thumbnail">🖼️ 썸네일 이미지</label>
        <div class="file-input-container">
          <input type="file" id="thumbnail" th:field="${postDTO.thumbnail}"
                 class="file-input" accept="image/*">
          <label for="thumbnail" class="file-label">
            썸네일 이미지를 선택해주세요
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>📎 첨부파일</label>
        <div id="fileInputs" class="file-inputs-container">
          <div class="file-input-container">
            <input type="file" id="attachments" name="attachments" class="file-input">
            <label for="attachments" class="file-label">
              파일을 선택하거나 드래그하여 업로드하세요
            </label>
          </div>
        </div>
        <button type="button" class="add-file-btn" onclick="addFileInput()">
          ➕ 파일 추가
        </button>
      </div>

      <!-- 기존 첨부파일 표시 -->
      <div th:if="${postDTO.attachments != null}" class="form-group">
        <label>📋 기존 첨부파일</label>
        <div class="existing-files">
          <div th:each="file : ${postDTO.attachments}" class="file-item">
            <a th:href="@{/files/{id}(id=${file.id})}"
               th:text="${file.originalFileName}"
               class="file-link">파일명</a>
            <div class="delete-checkbox">
              <input type="checkbox" name="deleteFileIds" th:value="${file.id}" th:id="'delete-' + ${file.id}">
              <label th:for="'delete-' + ${file.id}">🗑️ 삭제</label>
            </div>
          </div>
        </div>
      </div>

      <div class="submit-container">
        <button type="submit" class="submit-btn" id="submitBtn">
          <span th:text="${isEdit}? '수정하기' : '게시하기'">게시하기</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script th:if="${alertMessage}">
  alert('[[${alertMessage}]]');
</script>

<script>
  function addFileInput() {
    const container = document.getElementById("fileInputs");
    const fileInputDiv = document.createElement("div");
    fileInputDiv.className = "additional-file-input";

    const input = document.createElement("input");
    input.type = "file";
    input.name = "attachments";
    input.className = "file-input";

    const label = document.createElement("label");
    label.className = "file-label";
    label.textContent = "추가 파일을 선택해주세요";
    label.style.cursor = "pointer";

    // 고유 ID 생성
    const uniqueId = 'file-' + Date.now();
    input.id = uniqueId;
    label.setAttribute('for', uniqueId);

    const fileContainer = document.createElement("div");
    fileContainer.className = "file-input-container";
    fileContainer.appendChild(input);
    fileContainer.appendChild(label);

    fileInputDiv.appendChild(fileContainer);
    container.appendChild(fileInputDiv);

    // 파일 선택 시 레이블 업데이트
    input.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        label.textContent = '📎 ' + this.files[0].name;
        label.style.color = '#667eea';
      }
    });
  }

  // 기존 파일 입력에도 동일한 기능 추가
  document.addEventListener('DOMContentLoaded', function() {
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      input.addEventListener('change', function() {
        const label = document.querySelector(`label[for="${this.id}"]`);
        if (label && this.files && this.files[0]) {
          if (this.id === 'thumbnail') {
            label.textContent = '🖼️ ' + this.files[0].name;
          } else {
            label.textContent = '📎 ' + this.files[0].name;
          }
          label.style.color = '#667eea';
        }
      });
    });

    // 폼 제출 시 로딩 애니메이션
    const form = document.getElementById('postForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', function() {
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '처리중...';
    });
  });
</script>
</body>
</html>
